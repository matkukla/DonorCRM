---
phase: 01-foundation-data-model
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/journals/__init__.py
  - apps/journals/apps.py
  - apps/journals/models.py
  - apps/journals/admin.py
  - apps/journals/migrations/__init__.py
  - apps/journals/migrations/0001_initial.py
  - apps/journals/tests/__init__.py
  - config/settings/base.py
autonomous: true

must_haves:
  truths:
    - "Journal model exists with owner, name, goal_amount, deadline, is_archived, archived_at fields"
    - "JournalContact through-table links journals to contacts with unique_together constraint"
    - "JournalStageEvent stores append-only stage events with stage, event_type, notes, metadata, timestamp"
    - "PipelineStage enum defines 6 stages: CONTACT, MEET, CLOSE, DECISION, THANK, NEXT_STEPS"
    - "StageEventType enum defines typed events per stage (CALL_LOGGED, EMAIL_SENT, MEETING_SCHEDULED, etc.)"
    - "Migrations run cleanly and create all tables"
  artifacts:
    - path: "apps/journals/models.py"
      provides: "Journal, JournalContact, JournalStageEvent models + PipelineStage, StageEventType enums"
      contains: "class Journal(TimeStampedModel)"
    - path: "apps/journals/apps.py"
      provides: "JournalsConfig AppConfig"
      contains: "class JournalsConfig"
    - path: "config/settings/base.py"
      provides: "journals app registered in LOCAL_APPS"
      contains: "apps.journals"
  key_links:
    - from: "apps/journals/models.py"
      to: "apps/core/models.py"
      via: "TimeStampedModel inheritance"
      pattern: "from apps.core.models import TimeStampedModel"
    - from: "apps/journals/models.py"
      to: "apps/contacts/models.py"
      via: "ForeignKey to Contact in JournalContact"
      pattern: "models.ForeignKey.*contacts.Contact"
    - from: "config/settings/base.py"
      to: "apps/journals/apps.py"
      via: "INSTALLED_APPS registration"
      pattern: "apps.journals"
---

<objective>
Create the journals Django app with all Phase 1 models, enums, and database migrations.

Purpose: Establishes the data foundation that all subsequent plans build on. Without these models, no API endpoints, permissions, or event logging can be created.
Output: A fully-migrated journals app with Journal, JournalContact, and JournalStageEvent models, registered in Django settings.
</objective>

<execution_context>
@/home/matkukla/.claude/get-shit-done/workflows/execute-plan.md
@/home/matkukla/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-data-model/01-RESEARCH.md
@apps/core/models.py
@apps/events/models.py
@apps/pledges/models.py
@config/settings/base.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create journals app structure and models</name>
  <files>
    apps/journals/__init__.py
    apps/journals/apps.py
    apps/journals/models.py
    apps/journals/admin.py
    apps/journals/tests/__init__.py
  </files>
  <action>
Create the journals app directory structure and implement all models:

1. `apps/journals/__init__.py` - Empty file.

2. `apps/journals/apps.py` - AppConfig:
```python
class JournalsConfig(AppConfig):
    name = 'apps.journals'
    verbose_name = 'Journals'

    def ready(self):
        import apps.journals.signals  # noqa: F401
```
Note: signals.py will be created in Plan 02. The import will fail until then, but that's fine - Plan 02 creates it before the app is loaded in a running server.

3. `apps/journals/models.py` - All models and enums:

**PipelineStage** (TextChoices):
- CONTACT = 'contact', 'Contact'
- MEET = 'meet', 'Meet'
- CLOSE = 'close', 'Close'
- DECISION = 'decision', 'Decision'
- THANK = 'thank', 'Thank'
- NEXT_STEPS = 'next_steps', 'Next Steps'

**StageEventType** (TextChoices) - typed events per stage:
- CALL_LOGGED = 'call_logged', 'Call Logged'
- EMAIL_SENT = 'email_sent', 'Email Sent'
- TEXT_SENT = 'text_sent', 'Text Sent'
- LETTER_SENT = 'letter_sent', 'Letter Sent'
- MEETING_SCHEDULED = 'meeting_scheduled', 'Meeting Scheduled'
- MEETING_COMPLETED = 'meeting_completed', 'Meeting Completed'
- ASK_MADE = 'ask_made', 'Ask Made'
- FOLLOW_UP_SCHEDULED = 'follow_up_scheduled', 'Follow-up Scheduled'
- FOLLOW_UP_COMPLETED = 'follow_up_completed', 'Follow-up Completed'
- DECISION_RECEIVED = 'decision_received', 'Decision Received'
- THANK_YOU_SENT = 'thank_you_sent', 'Thank You Sent'
- NEXT_STEP_CREATED = 'next_step_created', 'Next Step Created'
- NOTE_ADDED = 'note_added', 'Note Added'
- OTHER = 'other', 'Other'

**Journal** model (inherits TimeStampedModel):
- owner: ForeignKey to AUTH_USER_MODEL, on_delete=PROTECT, related_name='journals', db_index=True
- name: CharField max_length=255
- goal_amount: DecimalField(max_digits=10, decimal_places=2, validators=[MinValueValidator(Decimal('0.01'))])
- deadline: DateField(null=True, blank=True)
- is_archived: BooleanField(default=False, db_index=True)
- archived_at: DateTimeField(null=True, blank=True)
- Meta: db_table='journals', ordering=['-created_at'], indexes=[Index(fields=['owner', 'is_archived'])]
- __str__: return self.name
- archive() method: sets is_archived=True, archived_at=timezone.now(), save(update_fields=['is_archived', 'archived_at', 'updated_at'])

**JournalContact** model (inherits TimeStampedModel):
- journal: ForeignKey to 'Journal', on_delete=CASCADE, related_name='journal_contacts', db_index=True
- contact: ForeignKey to 'contacts.Contact', on_delete=CASCADE, related_name='journal_memberships', db_index=True
- Meta: db_table='journal_contacts', unique_together=[['journal', 'contact']], indexes=[Index(fields=['journal', 'contact'])]
- __str__: return f'{self.contact} in {self.journal}'

**JournalStageEvent** model (inherits TimeStampedModel):
- journal_contact: ForeignKey to 'JournalContact', on_delete=CASCADE, related_name='stage_events', db_index=True
- stage: CharField max_length=20, choices=PipelineStage.choices, db_index=True
- event_type: CharField max_length=30, choices=StageEventType.choices, db_index=True
- notes: TextField(blank=True)
- metadata: JSONField(default=dict, blank=True)
- triggered_by: ForeignKey to AUTH_USER_MODEL, on_delete=SET_NULL, null=True, blank=True, related_name='triggered_stage_events'
- Meta: db_table='journal_stage_events', ordering=['-created_at'], indexes=[Index(fields=['journal_contact', 'stage', 'created_at']), Index(fields=['journal_contact', 'created_at'])]
- __str__: return f'{self.stage} - {self.event_type}'

4. `apps/journals/admin.py` - Register models:
```python
from django.contrib import admin
from apps.journals.models import Journal, JournalContact, JournalStageEvent

@admin.register(Journal)
class JournalAdmin(admin.ModelAdmin):
    list_display = ['name', 'owner', 'goal_amount', 'deadline', 'is_archived', 'created_at']
    list_filter = ['is_archived', 'created_at']
    search_fields = ['name', 'owner__email']
    readonly_fields = ['id', 'created_at', 'updated_at']

@admin.register(JournalContact)
class JournalContactAdmin(admin.ModelAdmin):
    list_display = ['journal', 'contact', 'created_at']
    list_filter = ['created_at']

@admin.register(JournalStageEvent)
class JournalStageEventAdmin(admin.ModelAdmin):
    list_display = ['journal_contact', 'stage', 'event_type', 'created_at']
    list_filter = ['stage', 'event_type', 'created_at']
```

5. `apps/journals/tests/__init__.py` - Empty file.

Follow these conventions:
- Use absolute imports (from apps.journals.models import ...), NOT relative imports
- Use 'verbose_name' positional arg on fields (e.g., models.CharField('name', ...))
- Include help_text on non-obvious fields
- Add db_index=True to all ForeignKey fields and status/boolean filter fields
  </action>
  <verify>
Run: `python manage.py check --deploy 2>&1 | head -20` should show no errors related to journals app (may show deployment warnings which are fine).
Run: `python -c "from apps.journals.models import Journal, JournalContact, JournalStageEvent, PipelineStage, StageEventType; print('Models imported OK')"` from the project root.
  </verify>
  <done>All three models and both enums are defined in apps/journals/models.py. Models inherit TimeStampedModel. Admin is registered. Tests directory exists.</done>
</task>

<task type="auto">
  <name>Task 2: Register app and run migrations</name>
  <files>
    config/settings/base.py
    apps/journals/migrations/__init__.py
    apps/journals/migrations/0001_initial.py
  </files>
  <action>
1. Add 'apps.journals' to LOCAL_APPS in config/settings/base.py, after 'apps.imports' (last entry). Keep the list formatting consistent with existing entries.

2. Create `apps/journals/migrations/__init__.py` - Empty file.

3. Create a placeholder `apps/journals/signals.py` with just a docstring so the apps.py ready() import doesn't fail:
```python
"""
Signals for journal event logging.
Full implementation in Plan 02.
"""
```

4. Run `python manage.py makemigrations journals` to generate the initial migration.

5. Run `python manage.py migrate` to apply the migration.

6. Verify the tables exist by running:
```python
python manage.py shell -c "
from apps.journals.models import Journal, JournalContact, JournalStageEvent
from apps.journals.models import PipelineStage, StageEventType
print('Tables:', Journal._meta.db_table, JournalContact._meta.db_table, JournalStageEvent._meta.db_table)
print('Stages:', [s.value for s in PipelineStage])
print('Event types:', len(StageEventType.choices), 'types')
"
```
  </action>
  <verify>
`python manage.py showmigrations journals` shows [X] 0001_initial (migration applied).
`python manage.py shell -c "from apps.journals.models import Journal; print(Journal.objects.count())"` returns 0 without error.
  </verify>
  <done>journals app registered in settings. Migration created and applied. All three tables exist in the database. Enums are accessible from model imports.</done>
</task>

</tasks>

<verification>
1. `python manage.py check` passes without errors
2. `python manage.py showmigrations journals` shows applied migration
3. All models importable: Journal, JournalContact, JournalStageEvent, PipelineStage, StageEventType
4. Database tables exist: journals, journal_contacts, journal_stage_events
5. Journal model has archive() method that sets is_archived and archived_at
6. JournalContact has unique_together on (journal, contact)
7. JournalStageEvent has composite indexes for efficient querying
</verification>

<success_criteria>
- journals app exists in apps/ directory with proper Django app structure
- All three models inherit from TimeStampedModel (UUID PK, timestamps)
- PipelineStage defines exactly 6 stages
- StageEventType defines 14 event types covering all stages
- Journal has DecimalField for goal_amount (NOT integer cents)
- Journal has archive pattern (is_archived + archived_at + archive() method)
- Migration is applied and tables exist in database
- App registered in LOCAL_APPS
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-data-model/01-01-SUMMARY.md`
</output>
