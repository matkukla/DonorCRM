---
phase: 02-contact-membership-search
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/journals/tests/__init__.py
  - apps/journals/tests/test_journal_members.py
autonomous: true

must_haves:
  truths:
    - "Tests prove adding a contact to a journal returns 201 with correct response shape"
    - "Tests prove duplicate add returns 400 with descriptive message"
    - "Tests prove contact belonging to different user cannot be added (403/400)"
    - "Tests prove DELETE removes membership and returns 204"
    - "Tests prove contact can belong to multiple journals simultaneously"
    - "Tests prove search by name/email filters results correctly"
    - "Tests prove contact__status filter works"
    - "Tests prove non-owner cannot list or modify another user's journal memberships"
  artifacts:
    - path: "apps/journals/tests/__init__.py"
      provides: "Test package init"
    - path: "apps/journals/tests/test_journal_members.py"
      provides: "Integration tests for journal membership API"
      min_lines: 100
  key_links:
    - from: "apps/journals/tests/test_journal_members.py"
      to: "apps/journals/views.py"
      via: "API client calls to journal-member endpoints"
      pattern: "self\\.client\\.(post|get|delete).*journal-member"
    - from: "apps/journals/tests/test_journal_members.py"
      to: "apps/journals/models.py"
      via: "JournalContact.objects for test setup"
      pattern: "JournalContact\\.objects\\.(create|filter|count)"
---

<objective>
Write integration tests that verify all Phase 2 success criteria: membership CRUD, duplicate handling, ownership validation, multi-journal membership, search, and filtering.

Purpose: Proves the API works correctly and catches regressions. Validates all 5 success criteria from the roadmap.
Output: Passing test suite covering membership operations, permissions, search, and filtering.
</objective>

<execution_context>
@/home/matkukla/.claude/get-shit-done/workflows/execute-plan.md
@/home/matkukla/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/journals/models.py
@apps/journals/views.py
@apps/journals/serializers.py
@apps/journals/urls.py
@apps/contacts/models.py
@apps/core/permissions.py
@.planning/phases/02-contact-membership-search/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test package and journal membership tests</name>
  <files>apps/journals/tests/__init__.py, apps/journals/tests/test_journal_members.py</files>
  <action>
1. Create apps/journals/tests/__init__.py (empty file).
   If apps/journals/tests.py exists, remove it first (Django prefers tests/ package over tests.py file).

2. Create apps/journals/tests/test_journal_members.py with these test cases using DRF's APITestCase:

Setup (setUp method):
- Create two users (user_a and user_b) using the project's User model (apps.users.models.User or settings.AUTH_USER_MODEL)
- Set user_a.role = 'staff', user_b.role = 'staff'
- Create a journal owned by user_a
- Create 3 contacts owned by user_a (with varied names/emails for search testing, and different statuses: prospect, donor, asked)
- Create 1 contact owned by user_b
- self.client.force_authenticate(user_a) for most tests

Test cases to implement:

**Membership CRUD:**
a. test_add_contact_to_journal_success:
   - POST /api/v1/journals/journal-members/ with {journal: journal.id, contact: contact_a.id}
   - Assert 201, response has id, journal, contact, contact_name, contact_email, created_at
   - Assert JournalContact.objects.count() == 1

b. test_add_multiple_contacts:
   - POST three different contacts to same journal
   - Assert all return 201
   - Assert JournalContact.objects.filter(journal=journal).count() == 3

c. test_remove_contact_from_journal:
   - Create a JournalContact, then DELETE /api/v1/journals/journal-members/{jc.id}/
   - Assert 204
   - Assert JournalContact.objects.count() == 0

**Duplicate handling (Success Criterion 3):**
d. test_duplicate_membership_returns_400:
   - POST same journal+contact twice
   - First returns 201, second returns 400
   - Assert response has 'detail' key with descriptive message

**Multi-journal membership (Success Criterion 3):**
e. test_contact_in_multiple_journals:
   - Create second journal for user_a
   - Add same contact to both journals
   - Both return 201
   - Assert JournalContact.objects.filter(contact=contact).count() == 2

**Ownership validation:**
f. test_cannot_add_contact_owned_by_other_user:
   - POST with contact owned by user_b
   - Assert 400 with validation error on 'contact' field

g. test_cannot_add_to_journal_owned_by_other_user:
   - Authenticate as user_b
   - POST with user_a's journal and user_b's contact
   - Assert 400 with validation error on 'journal' field

h. test_cannot_list_other_users_memberships:
   - Create membership for user_a's journal
   - Authenticate as user_b
   - GET /api/v1/journals/journal-members/
   - Assert empty results (count == 0)

i. test_cannot_delete_other_users_membership:
   - Create membership for user_a's journal
   - Authenticate as user_b
   - DELETE that membership
   - Assert 404 (queryset filters it out)

**Search (Success Criterion 4):**
j. test_search_by_first_name:
   - Add 3 contacts to journal
   - GET ?journal_id=X&search={first_name_of_contact_1}
   - Assert results count == 1, correct contact returned

k. test_search_by_email:
   - GET ?journal_id=X&search={partial_email}
   - Assert correct contact returned

l. test_search_case_insensitive:
   - GET ?search=UPPERCASE_VERSION_OF_NAME
   - Assert still finds the contact

**Filtering (Success Criterion 5):**
m. test_filter_by_contact_status:
   - Add contacts with different statuses (prospect, donor, asked)
   - GET ?journal_id=X&contact__status=donor
   - Assert only donor contacts returned

n. test_filter_and_search_combined:
   - GET ?journal_id=X&search=name&contact__status=prospect
   - Assert intersection returned correctly

**Archived journals:**
o. test_archived_journal_memberships_excluded:
   - Create membership, then archive the journal
   - GET /api/v1/journals/journal-members/
   - Assert membership not in results

**Listing:**
p. test_list_with_journal_id_filter:
   - Create memberships in two journals
   - GET ?journal_id=journal_1.id
   - Assert only journal_1 memberships returned

Use reverse('journals:journal-member-list') and reverse('journals:journal-member-detail', kwargs={'pk': jc.id}) for URLs.
  </action>
  <verify>
Run: python manage.py test apps.journals.tests.test_journal_members --verbosity=2 from project root.
All tests should pass.
  </verify>
  <done>All 16 test cases pass. Tests cover: CRUD operations, duplicate handling, multi-journal membership, ownership validation (both journal and contact), search by name/email (case-insensitive), filtering by contact status, combined search+filter, archived journal exclusion, and journal_id list filtering.</done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite and verify no regressions</name>
  <files></files>
  <action>
1. Run the complete project test suite to ensure Phase 2 changes don't break existing functionality:
   python manage.py test --verbosity=2

2. Run python manage.py check to verify no system check errors.

3. Run python manage.py makemigrations --check --dry-run to confirm no pending migrations (Phase 2 has no model changes).

4. If any tests fail, diagnose and fix. Common issues:
   - Import paths wrong (check apps.journals.tests is discoverable)
   - User model creation (check AUTH_USER_MODEL setting and required fields)
   - URL namespace (ensure 'journals' app_name matches in urls.py)
  </action>
  <verify>
python manage.py test --verbosity=2 exits with 0 failures, 0 errors.
python manage.py check exits with "System check identified no issues."
python manage.py makemigrations --check --dry-run exits with "No changes detected."
  </verify>
  <done>Full test suite passes. No regressions. No pending migrations. System checks clean.</done>
</task>

</tasks>

<verification>
1. All journal membership tests pass (16 test cases)
2. Full project test suite passes (no regressions)
3. No pending migrations
4. System checks pass
5. Each Phase 2 success criterion has at least one test covering it:
   - SC1 (add contacts): test_add_contact_to_journal_success, test_add_multiple_contacts
   - SC2 (remove contacts): test_remove_contact_from_journal
   - SC3 (multi-journal): test_contact_in_multiple_journals, test_duplicate_membership_returns_400
   - SC4 (search): test_search_by_first_name, test_search_by_email, test_search_case_insensitive
   - SC5 (filter by status): test_filter_by_contact_status, test_filter_and_search_combined
</verification>

<success_criteria>
- 16 integration tests pass covering all success criteria
- Full test suite has 0 failures and 0 errors
- Tests verify both happy paths and error cases
- Permission/ownership tests prove security boundaries
- Search tests prove case-insensitive partial matching
- Filter tests prove contact__status filtering works
</success_criteria>

<output>
After completion, create `.planning/phases/02-contact-membership-search/02-02-SUMMARY.md`
</output>
