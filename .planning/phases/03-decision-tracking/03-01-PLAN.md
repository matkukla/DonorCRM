---
phase: 03-decision-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/journals/models.py
  - apps/journals/migrations/0002_decision_decisionhistory.py
autonomous: true

must_haves:
  truths:
    - "Decision model exists with amount (DecimalField), cadence (TextChoices), and status (TextChoices) fields"
    - "DecisionHistory model exists with decision FK, changed_fields JSONField, and changed_by user FK"
    - "UniqueConstraint enforces one decision per journal_contact"
    - "monthly_equivalent property correctly calculates normalized monthly value for all cadences"
  artifacts:
    - path: "apps/journals/models.py"
      provides: "Decision, DecisionHistory, DecisionCadence, DecisionStatus"
      contains: "class Decision"
    - path: "apps/journals/migrations/0002_decision_decisionhistory.py"
      provides: "Database tables for decision tracking"
  key_links:
    - from: "apps/journals/models.py (Decision)"
      to: "apps/journals/models.py (JournalContact)"
      via: "ForeignKey journal_contact"
      pattern: "models.ForeignKey.*JournalContact"
    - from: "apps/journals/models.py (DecisionHistory)"
      to: "apps/journals/models.py (Decision)"
      via: "ForeignKey decision"
      pattern: "models.ForeignKey.*Decision"
---

<objective>
Create Decision and DecisionHistory models with cadence enums and monthly equivalent calculation.

Purpose: Establish the dual-table data model for tracking current decision state (mutable, unique per journal+contact) and append-only history of changes.
Output: Two new models in journals app with migration applied, ready for serializer/view layer.
</objective>

<execution_context>
@/home/matkukla/.claude/get-shit-done/workflows/execute-plan.md
@/home/matkukla/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-decision-tracking/03-RESEARCH.md
@apps/journals/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Decision and DecisionHistory models with enums</name>
  <files>apps/journals/models.py</files>
  <action>
Add to apps/journals/models.py (after JournalStageEvent class):

1. DecisionCadence TextChoices enum:
   - ONE_TIME = 'one_time', 'One-Time'
   - MONTHLY = 'monthly', 'Monthly'
   - QUARTERLY = 'quarterly', 'Quarterly'
   - ANNUAL = 'annual', 'Annual'

2. DecisionStatus TextChoices enum:
   - PENDING = 'pending', 'Pending'
   - ACTIVE = 'active', 'Active'
   - PAUSED = 'paused', 'Paused'
   - DECLINED = 'declined', 'Declined'

3. Decision model (inherits TimeStampedModel):
   - journal_contact: ForeignKey to JournalContact, on_delete=CASCADE, related_name='decisions', db_index=True
   - amount: DecimalField(max_digits=10, decimal_places=2, validators=[MinValueValidator(Decimal('0.01'))]), help_text='Pledged amount'
   - cadence: CharField(max_length=20, choices=DecisionCadence.choices, default=DecisionCadence.MONTHLY)
   - status: CharField(max_length=20, choices=DecisionStatus.choices, default=DecisionStatus.PENDING, db_index=True)
   - Meta: db_table='journal_decisions', UniqueConstraint(fields=['journal_contact'], name='unique_decision_per_journal_contact')
   - __str__: return f'{self.journal_contact} - {self.amount} ({self.cadence})'
   - @property monthly_equivalent: Uses Decimal multipliers dict:
     - ONE_TIME: Decimal('0') (excluded from monthly)
     - MONTHLY: Decimal('1')
     - QUARTERLY: Decimal('1') / Decimal('3') — use round(result, 2)
     - ANNUAL: Decimal('1') / Decimal('12') — use round(result, 2)
     - Return: round(self.amount * multiplier, 2)

4. DecisionHistory model (inherits TimeStampedModel):
   - decision: ForeignKey to Decision, on_delete=CASCADE, related_name='history', db_index=True
   - changed_fields: JSONField(help_text='Mapping of field names to old values before change')
   - changed_by: ForeignKey to settings.AUTH_USER_MODEL, on_delete=SET_NULL, null=True, related_name='decision_changes'
   - Meta: db_table='journal_decision_history', ordering=['-created_at'], indexes=[Index(fields=['decision', '-created_at'])]
   - __str__: return f'History for {self.decision} at {self.created_at}'

Follow existing codebase conventions:
- Use verbose_name positional arg on fields (like existing models in this file)
- Import Decimal at top (already imported)
- MinValueValidator already imported
- Use settings.AUTH_USER_MODEL (already imported via django.conf)
  </action>
  <verify>
Run: `python manage.py check` — must pass with no errors.
Verify models are importable: `python -c "from apps.journals.models import Decision, DecisionHistory, DecisionCadence, DecisionStatus; print('OK')"`
  </verify>
  <done>Decision and DecisionHistory models exist in models.py with all fields, enums, constraints, and monthly_equivalent property</done>
</task>

<task type="auto">
  <name>Task 2: Create and apply migration</name>
  <files>apps/journals/migrations/0002_decision_decisionhistory.py</files>
  <action>
Run: `python manage.py makemigrations journals --name decision_decisionhistory`

Then apply: `python manage.py migrate journals`

Verify tables created: `python manage.py dbshell` and run:
- `\dt journal_decisions` — table must exist
- `\dt journal_decision_history` — table must exist
- `\d journal_decisions` — verify unique constraint on journal_contact_id

If dbshell is not available, use Django ORM verification:
`python -c "from apps.journals.models import Decision, DecisionHistory; print(Decision.objects.count(), DecisionHistory.objects.count())"`
  </action>
  <verify>
Run: `python manage.py showmigrations journals` — 0002 must show [X] (applied).
Run: `python manage.py check` — no errors.
  </verify>
  <done>Migration 0002 exists and is applied, journal_decisions and journal_decision_history tables exist in database</done>
</task>

</tasks>

<verification>
1. `python manage.py check` passes
2. Both models importable from apps.journals.models
3. Migration applied successfully
4. UniqueConstraint on journal_contact verified
5. monthly_equivalent returns correct values:
   - Decision(amount=100, cadence='monthly').monthly_equivalent == Decimal('100.00')
   - Decision(amount=300, cadence='quarterly').monthly_equivalent == Decimal('100.00')
   - Decision(amount=1200, cadence='annual').monthly_equivalent == Decimal('100.00')
   - Decision(amount=500, cadence='one_time').monthly_equivalent == Decimal('0')
</verification>

<success_criteria>
- Decision and DecisionHistory models exist with all specified fields
- DecisionCadence and DecisionStatus enums exist with correct choices
- UniqueConstraint ensures one decision per journal_contact
- monthly_equivalent property calculates correctly for all 4 cadences
- Migration 0002 applied, tables exist in database
- `python manage.py check` passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-decision-tracking/03-01-SUMMARY.md`
</output>
