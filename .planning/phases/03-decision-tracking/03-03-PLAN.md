---
phase: 03-decision-tracking
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - apps/journals/tests/test_decisions.py
autonomous: true

must_haves:
  truths:
    - "User can record a decision with amount, cadence, and status via API"
    - "User can update an existing decision, and system appends old state to history"
    - "System calculates monthly equivalent correctly for all cadences"
    - "User can retrieve decision history paginated at 25 records per page"
    - "Unique constraint prevents duplicate decisions per journal_contact"
  artifacts:
    - path: "apps/journals/tests/test_decisions.py"
      provides: "Integration tests covering all Phase 3 success criteria"
      contains: "class DecisionAPITests"
  key_links:
    - from: "apps/journals/tests/test_decisions.py"
      to: "apps/journals/views.py"
      via: "API endpoint testing through Django test client"
      pattern: "reverse.*decision"
    - from: "apps/journals/tests/test_decisions.py"
      to: "apps/journals/models.py"
      via: "Direct model assertions for history and monthly_equivalent"
      pattern: "DecisionHistory.objects"
---

<objective>
Create comprehensive integration tests verifying all Phase 3 success criteria.

Purpose: Prove that decision CRUD, atomic history tracking, cadence normalization, pagination, and unique constraints all work correctly end-to-end.
Output: Test file that exercises every success criterion for the phase.
</objective>

<execution_context>
@/home/matkukla/.claude/get-shit-done/workflows/execute-plan.md
@/home/matkukla/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-decision-tracking/03-RESEARCH.md
@.planning/phases/03-decision-tracking/03-02-SUMMARY.md
@apps/journals/models.py
@apps/journals/serializers.py
@apps/journals/views.py
@apps/journals/urls.py
@apps/journals/tests/test_journal_members.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create decision CRUD and constraint tests</name>
  <files>apps/journals/tests/test_decisions.py</files>
  <action>
Create apps/journals/tests/test_decisions.py following the pattern from test_journal_members.py.

Use APITestCase with force_authenticate. Import User via get_user_model().

**setUp:**
- Create user_a (staff role) and user_b (staff role)
- Create journal owned by user_a
- Create contact owned by user_a
- Create JournalContact linking journal + contact
- Authenticate as user_a

**Test cases for Success Criterion 1 (record decision with amount/cadence/status):**
- test_create_decision_success: POST decisions/ with journal_contact, amount=100.00, cadence='monthly', status='pending'. Assert 201, response has id, amount, cadence, status, monthly_equivalent.
- test_create_decision_all_cadences: Test creating decisions with each cadence value (one_time, monthly, quarterly, annual). Each should succeed with 201.
- test_create_decision_all_statuses: Test creating with each status (pending, active, paused, declined). Each should succeed.
- test_create_decision_without_optional_fields: POST with only journal_contact and amount. Defaults should be cadence=monthly, status=pending.

**Test cases for Success Criterion 5 (unique constraint):**
- test_duplicate_decision_returns_400: Create a decision, then POST again for same journal_contact. Assert 400 with 'already exists' in response.
- test_different_contacts_can_have_decisions: Create decisions for two different journal_contacts in same journal. Both should succeed.

**Test cases for ownership:**
- test_cannot_create_decision_for_other_users_journal: user_b tries to create decision for user_a's journal_contact. Assert 400.
- test_cannot_list_other_users_decisions: user_b GETs decisions/. Assert 0 results (user_a's decisions not visible).
- test_cannot_update_other_users_decision: user_b tries PATCH on user_a's decision. Assert 404.

**Test cases for listing/filtering:**
- test_list_decisions_filtered_by_journal_contact_id: Create decision, GET with journal_contact_id param. Assert filtered correctly.
- test_list_decisions_filtered_by_journal_id: Create decision, GET with journal_id param. Assert filtered correctly.

Use str() for UUID comparisons in assertions (learned from 02-02 decision).
  </action>
  <verify>
Run: `python manage.py test apps.journals.tests.test_decisions -v2 --no-input` — all tests must pass.
  </verify>
  <done>All decision CRUD and constraint tests pass, covering success criteria 1 and 5</done>
</task>

<task type="auto">
  <name>Task 2: Create history tracking, cadence normalization, and pagination tests</name>
  <files>apps/journals/tests/test_decisions.py</files>
  <action>
Add to the same test file (apps/journals/tests/test_decisions.py), in a new test class:

**class DecisionHistoryTests(APITestCase):**

**setUp:**
- Same as DecisionAPITests setup
- Also create an initial decision for the journal_contact

**Test cases for Success Criterion 2 (update appends to history):**
- test_update_decision_creates_history: PATCH decision with new amount. Assert 200. Assert DecisionHistory.objects.count() == 1. Assert history record has changed_fields={'amount': '<old_value>'}, changed_by=user_a.
- test_update_multiple_fields_creates_single_history: PATCH with new amount AND new cadence. Assert single history record with both fields in changed_fields dict.
- test_update_same_value_no_history: PATCH decision with same amount (no change). Assert DecisionHistory.objects.count() == 0 (no history created for no-op).
- test_multiple_updates_create_multiple_history: PATCH amount first, then PATCH cadence second. Assert 2 history records exist, ordered by -created_at.
- test_history_records_old_value_not_new: After PATCH amount from 100 to 200, history changed_fields['amount'] should be '100.00' (old value as string).

**Test cases for Success Criterion 3 (monthly equivalent calculation):**
- test_monthly_equivalent_monthly: Create decision amount=100, cadence=monthly. Assert monthly_equivalent in response == '100.00'.
- test_monthly_equivalent_quarterly: Create decision amount=300, cadence=quarterly. Assert monthly_equivalent == '100.00'.
- test_monthly_equivalent_annual: Create decision amount=1200, cadence=annual. Assert monthly_equivalent == '100.00'.
- test_monthly_equivalent_one_time: Create decision amount=500, cadence=one_time. Assert monthly_equivalent == '0.00' (excluded from monthly).
- test_monthly_equivalent_updates_after_cadence_change: Create monthly decision amount=100. PATCH cadence to quarterly. Assert new monthly_equivalent == '33.33'.

**Test cases for Success Criterion 4 (paginated history):**
- test_history_list_paginated_default_25: Create 30 history records (by updating decision 30 times with different amounts). GET decision-history/?decision_id={id}. Assert results count == 25 (page 1), assert 'next' URL present.
- test_history_list_page_2: Same setup, GET with page=2. Assert remaining records returned.
- test_history_list_custom_page_size: GET with page_size=5. Assert 5 results.
- test_history_filtered_by_journal_contact_id: Create decisions for two journal_contacts. GET history with journal_contact_id filter. Assert only matching history returned.

**Test for atomic transaction integrity:**
- test_history_and_update_are_atomic: PATCH decision with new amount. Verify both the decision is updated AND history record exists (both or neither should succeed - this confirms transaction.atomic() wrapping).

Use str() for UUID and Decimal comparisons. Access paginated response via response.data['results'] and response.data['count'].
  </action>
  <verify>
Run: `python manage.py test apps.journals.tests.test_decisions -v2 --no-input` — ALL tests must pass (both classes).
  </verify>
  <done>All history, cadence, and pagination tests pass, covering success criteria 2, 3, and 4. Full Phase 3 test coverage achieved.</done>
</task>

</tasks>

<verification>
1. `python manage.py test apps.journals.tests.test_decisions -v2 --no-input` — all tests pass
2. Tests cover all 5 success criteria for Phase 3:
   - SC1: Record decision with amount/cadence/status (test_create_decision_*)
   - SC2: Update appends to history (test_update_decision_*)
   - SC3: Monthly equivalent calculation (test_monthly_equivalent_*)
   - SC4: Paginated history retrieval (test_history_list_*)
   - SC5: Unique constraint enforced (test_duplicate_decision_*)
3. No test uses mocking — all tests exercise the full API stack
</verification>

<success_criteria>
- All tests pass with `python manage.py test apps.journals.tests.test_decisions -v2`
- Every Phase 3 success criterion has at least one corresponding test
- History records created atomically with decision updates
- Monthly equivalent calculated correctly for all 4 cadences
- Pagination defaults to 25, supports custom page_size
- Ownership isolation verified (user cannot access other's decisions/history)
</success_criteria>

<output>
After completion, create `.planning/phases/03-decision-tracking/03-03-SUMMARY.md`
</output>
