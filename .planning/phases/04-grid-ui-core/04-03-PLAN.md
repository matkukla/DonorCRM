---
phase: 04-grid-ui-core
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - frontend/src/pages/journals/components/JournalGrid.tsx
  - frontend/src/pages/journals/components/StageCell.tsx
  - frontend/src/pages/journals/components/ContactNameCell.tsx
autonomous: true

must_haves:
  truths:
    - "Grid displays contacts as rows, stages as columns"
    - "Header row stays fixed when scrolling vertically"
    - "Contact name column stays fixed when scrolling horizontally"
    - "Stage cells show color-coded checkmarks based on event freshness"
    - "Hovering stage cell shows tooltip with last event summary"
  artifacts:
    - path: "frontend/src/pages/journals/components/JournalGrid.tsx"
      provides: "Main grid component with sticky headers"
      exports: ["JournalGrid"]
    - path: "frontend/src/pages/journals/components/StageCell.tsx"
      provides: "Memoized stage cell with freshness indicator"
      exports: ["StageCell"]
  key_links:
    - from: "frontend/src/pages/journals/components/StageCell.tsx"
      to: "frontend/src/components/ui/tooltip.tsx"
      via: "Tooltip import"
      pattern: "from.*@/components/ui/tooltip"
    - from: "frontend/src/pages/journals/components/JournalGrid.tsx"
      to: "frontend/src/hooks/useJournals.ts"
      via: "useJournalMembers import"
      pattern: "from.*@/hooks/useJournals"
---

<objective>
Build the journal grid component with sticky headers, sticky contact names, and color-coded stage cells.

Purpose: The grid is the core UI for Phase 4. Users see contacts as rows, pipeline stages as columns, with visual indicators showing engagement freshness. This enables "at a glance" understanding of fundraising progress.

Output: JournalGrid component with sticky CSS positioning, memoized StageCell with freshness colors and tooltips.
</objective>

<execution_context>
@/home/matkukla/.claude/get-shit-done/workflows/execute-plan.md
@/home/matkukla/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-grid-ui-core/04-RESEARCH.md

Dependencies from prior plans:
@frontend/src/components/ui/tooltip.tsx (from 04-01)
@frontend/src/components/ui/badge.tsx (from 04-01)
@frontend/src/types/journals.ts (from 04-01)
@frontend/src/hooks/useJournals.ts (from 04-02)

Reference existing patterns:
@frontend/src/components/ui/table.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StageCell component</name>
  <files>frontend/src/pages/journals/components/StageCell.tsx</files>
  <action>
Create the memoized stage cell component at `frontend/src/pages/journals/components/StageCell.tsx`:

```typescript
import * as React from "react"
import { Check } from "lucide-react"
import { formatDistanceToNow } from "date-fns"
import { Badge } from "@/components/ui/badge"
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip"
import type { StageEventSummary, PipelineStage, FreshnessColor } from "@/types/journals"
import { getFreshnessColor, STAGE_LABELS } from "@/types/journals"

export interface StageCellProps {
  /** Contact ID for click handler */
  contactId: string
  /** Stage this cell represents */
  stage: PipelineStage
  /** Summary of events for this stage */
  eventSummary: StageEventSummary
  /** Click handler to open timeline drawer */
  onCellClick: (contactId: string, stage: PipelineStage) => void
}

/**
 * Memoized stage cell component for journal grid.
 *
 * Performance: Wrapped in React.memo with custom comparison to prevent
 * re-render cascade when other cells change. Only re-renders if this
 * cell's eventSummary changes.
 *
 * From RESEARCH.md: "All function props must be wrapped in useCallback
 * with stable dependencies"
 */
export const StageCell = React.memo<StageCellProps>(
  ({ contactId, stage, eventSummary, onCellClick }) => {
    const handleClick = React.useCallback(() => {
      onCellClick(contactId, stage)
    }, [contactId, stage, onCellClick])

    // Empty state - no events logged for this stage
    if (!eventSummary.has_events) {
      return (
        <button
          onClick={handleClick}
          className="h-10 w-10 flex items-center justify-center rounded hover:bg-muted/50 transition-colors"
          aria-label={`${STAGE_LABELS[stage]} - No events`}
        >
          <span className="sr-only">No events</span>
        </button>
      )
    }

    // Has events - show color-coded checkmark with tooltip
    const freshnessColor = getFreshnessColor(eventSummary.last_event_date)
    const relativeTime = eventSummary.last_event_date
      ? formatDistanceToNow(new Date(eventSummary.last_event_date), { addSuffix: true })
      : null

    // Format event type for display (e.g., "call_logged" -> "Call Logged")
    const eventTypeLabel = eventSummary.last_event_type
      ? eventSummary.last_event_type
          .split('_')
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ')
      : 'Event'

    return (
      <TooltipProvider>
        <Tooltip delayDuration={300}>
          <TooltipTrigger asChild>
            <button
              onClick={handleClick}
              className="h-10 w-10 flex items-center justify-center rounded hover:bg-muted/50 transition-colors"
              aria-label={`${STAGE_LABELS[stage]} - ${eventSummary.event_count} events, last ${relativeTime}`}
            >
              <Badge variant={freshnessColor} className="p-1">
                <Check className="h-4 w-4" />
              </Badge>
            </button>
          </TooltipTrigger>
          <TooltipContent side="top" className="max-w-xs">
            <p className="text-sm font-medium">{eventTypeLabel}</p>
            {relativeTime && (
              <p className="text-xs text-muted-foreground">{relativeTime}</p>
            )}
            {eventSummary.last_event_notes && (
              <p className="text-xs text-muted-foreground mt-1 line-clamp-2">
                {eventSummary.last_event_notes}
              </p>
            )}
            <p className="text-xs text-muted-foreground mt-1">
              {eventSummary.event_count} event{eventSummary.event_count !== 1 ? 's' : ''} total
            </p>
          </TooltipContent>
        </Tooltip>
      </TooltipProvider>
    )
  },
  // Custom comparison: only re-render if eventSummary changes
  (prevProps, nextProps) => {
    return (
      prevProps.eventSummary === nextProps.eventSummary &&
      prevProps.contactId === nextProps.contactId &&
      prevProps.stage === nextProps.stage &&
      prevProps.onCellClick === nextProps.onCellClick
    )
  }
)

StageCell.displayName = "StageCell"
```

Key aspects per RESEARCH.md:
- React.memo with custom comparison prevents cascade re-renders
- TooltipTrigger uses asChild to compose with click handler
- delayDuration={300} prevents tooltip interfering with quick clicks
- formatDistanceToNow from date-fns for "3 days ago" formatting
- Badge variant matches FreshnessColor type
- Accessible labels for screen readers
  </action>
  <verify>TypeScript compiles: `cd frontend && npx tsc --noEmit`</verify>
  <done>
StageCell component:
- Wrapped in React.memo with custom comparison
- Uses Tooltip with asChild for hover + click composition
- Shows color-coded Badge based on freshness
- Displays event summary in tooltip
- Has accessible button with aria-label
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ContactNameCell component</name>
  <files>frontend/src/pages/journals/components/ContactNameCell.tsx</files>
  <action>
Create the sticky contact name cell at `frontend/src/pages/journals/components/ContactNameCell.tsx`:

```typescript
import * as React from "react"

export interface ContactNameCellProps {
  /** Contact display name */
  name: string
  /** Contact email (optional) */
  email: string | null
  /** Contact status (for potential future badge) */
  status: string
}

/**
 * Contact name cell for the sticky first column.
 * Memoized to prevent re-renders when other cells change.
 */
export const ContactNameCell = React.memo<ContactNameCellProps>(
  ({ name, email }) => {
    return (
      <div className="flex flex-col min-w-[180px]">
        <span className="font-medium text-sm truncate">{name}</span>
        {email && (
          <span className="text-xs text-muted-foreground truncate">{email}</span>
        )}
      </div>
    )
  }
)

ContactNameCell.displayName = "ContactNameCell"
```

Simple component - the main complexity is in the parent grid's sticky positioning.
  </action>
  <verify>TypeScript compiles: `cd frontend && npx tsc --noEmit`</verify>
  <done>
ContactNameCell component:
- Displays contact name and email
- Memoized for performance
- min-w-[180px] ensures consistent sticky column width
  </done>
</task>

<task type="auto">
  <name>Task 3: Create JournalGrid component</name>
  <files>frontend/src/pages/journals/components/JournalGrid.tsx</files>
  <action>
Create the main grid component at `frontend/src/pages/journals/components/JournalGrid.tsx`:

```typescript
import * as React from "react"
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table"
import { StageCell } from "./StageCell"
import { ContactNameCell } from "./ContactNameCell"
import type { JournalMember, PipelineStage, StageEventSummary } from "@/types/journals"
import { PIPELINE_STAGES, STAGE_LABELS } from "@/types/journals"

export interface JournalGridProps {
  /** Journal members to display as rows */
  members: JournalMember[]
  /** Callback when a stage cell is clicked (opens timeline drawer) */
  onStageCellClick: (contactId: string, stage: PipelineStage) => void
  /** Loading state */
  isLoading?: boolean
}

/**
 * Journal grid component displaying contacts as rows, stages as columns.
 *
 * Implements sticky headers and first column per RESEARCH.md:
 * - Header row: sticky top-0 z-10
 * - Contact name column: sticky left-0 z-20
 * - Header/column intersection: sticky top-0 left-0 z-30
 *
 * Z-index hierarchy prevents overlap issues during scroll.
 */
export function JournalGrid({
  members,
  onStageCellClick,
  isLoading = false,
}: JournalGridProps) {
  // Memoize click handler to prevent StageCell re-renders
  const handleCellClick = React.useCallback(
    (contactId: string, stage: PipelineStage) => {
      onStageCellClick(contactId, stage)
    },
    [onStageCellClick]
  )

  // Empty state
  if (!isLoading && members.length === 0) {
    return (
      <div className="flex items-center justify-center h-48 text-muted-foreground">
        No contacts in this journal. Add contacts to get started.
      </div>
    )
  }

  // Loading state
  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-48 text-muted-foreground">
        Loading contacts...
      </div>
    )
  }

  return (
    <div className="relative w-full overflow-x-auto border rounded-lg">
      <Table>
        <TableHeader>
          <TableRow className="bg-background">
            {/* Intersection cell: sticky both directions, highest z-index */}
            <TableHead className="sticky top-0 left-0 z-30 bg-background min-w-[200px] border-r">
              Contact
            </TableHead>
            {/* Stage header cells: sticky top only */}
            {PIPELINE_STAGES.map((stage) => (
              <TableHead
                key={stage}
                className="sticky top-0 z-10 bg-background text-center w-20"
              >
                {STAGE_LABELS[stage]}
              </TableHead>
            ))}
          </TableRow>
        </TableHeader>
        <TableBody>
          {members.map((member) => (
            <TableRow key={member.id}>
              {/* Contact name cell: sticky left only */}
              <TableCell className="sticky left-0 z-20 bg-background border-r">
                <ContactNameCell
                  name={member.contact_name}
                  email={member.contact_email}
                  status={member.contact_status}
                />
              </TableCell>
              {/* Stage cells: not sticky */}
              {PIPELINE_STAGES.map((stage) => {
                const eventSummary = getStageEventSummary(member, stage)
                return (
                  <TableCell key={stage} className="text-center p-2">
                    <StageCell
                      contactId={member.contact}
                      stage={stage}
                      eventSummary={eventSummary}
                      onCellClick={handleCellClick}
                    />
                  </TableCell>
                )
              })}
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  )
}

/**
 * Helper to extract stage event summary from member data.
 * Returns empty summary if stage has no events.
 */
function getStageEventSummary(
  member: JournalMember,
  stage: PipelineStage
): StageEventSummary {
  const summary = member.stage_events?.[stage]
  if (summary) {
    return summary
  }
  // Default empty summary
  return {
    has_events: false,
    event_count: 0,
    last_event_date: null,
    last_event_type: null,
    last_event_notes: null,
  }
}
```

Key aspects per RESEARCH.md:
- Sticky positioning with z-index hierarchy (z-10, z-20, z-30)
- bg-background on all sticky elements to cover scrolling content
- overflow-x-auto on container for horizontal scroll
- useCallback for click handler to preserve StageCell memoization
- Table components from existing ui/table.tsx
  </action>
  <verify>TypeScript compiles: `cd frontend && npx tsc --noEmit`</verify>
  <done>
JournalGrid component:
- Displays contacts as rows, stages as columns
- Sticky header row with z-10
- Sticky contact name column with z-20
- Intersection cell with z-30 (highest)
- bg-background on all sticky elements
- Horizontal scroll via overflow-x-auto
- Memoized click handler for performance
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd frontend && npx tsc --noEmit`
2. StageCell uses React.memo: grep "React.memo" frontend/src/pages/journals/components/StageCell.tsx
3. Grid has sticky positioning: grep "sticky" frontend/src/pages/journals/components/JournalGrid.tsx
4. Z-index hierarchy correct: grep "z-10\|z-20\|z-30" frontend/src/pages/journals/components/JournalGrid.tsx
5. Tooltip integration: grep "Tooltip" frontend/src/pages/journals/components/StageCell.tsx
</verification>

<success_criteria>
- [ ] StageCell wrapped in React.memo with custom comparison function
- [ ] StageCell uses Tooltip with asChild for hover + click composition
- [ ] StageCell displays color-coded Badge based on getFreshnessColor
- [ ] JournalGrid has sticky header row (sticky top-0 z-10)
- [ ] JournalGrid has sticky contact name column (sticky left-0 z-20)
- [ ] JournalGrid has intersection cell (sticky top-0 left-0 z-30)
- [ ] All sticky elements have bg-background
- [ ] Grid container has overflow-x-auto for horizontal scroll
- [ ] All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-grid-ui-core/04-03-SUMMARY.md`
</output>
