---
phase: 04-grid-ui-core
plan: 04
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - frontend/src/pages/journals/components/EventTimelineDrawer.tsx
autonomous: true

must_haves:
  truths:
    - "Drawer opens from right side of screen"
    - "Timeline shows chronological events for selected stage"
    - "Load More button fetches additional events"
    - "Drawer shows loading state while fetching"
  artifacts:
    - path: "frontend/src/pages/journals/components/EventTimelineDrawer.tsx"
      provides: "Event timeline drawer with infinite scroll"
      exports: ["EventTimelineDrawer"]
  key_links:
    - from: "frontend/src/pages/journals/components/EventTimelineDrawer.tsx"
      to: "frontend/src/components/ui/sheet.tsx"
      via: "Sheet import"
      pattern: "from.*@/components/ui/sheet"
    - from: "frontend/src/pages/journals/components/EventTimelineDrawer.tsx"
      to: "frontend/src/hooks/useJournals.ts"
      via: "useStageEventsInfinite import"
      pattern: "useStageEventsInfinite"
---

<objective>
Build the event timeline drawer component with paginated event loading.

Purpose: When users click a stage cell, they need to see the full event history for that contact in that stage. The drawer provides detailed context with "Load More" pagination for longer histories.

Output: EventTimelineDrawer component using Sheet, useInfiniteQuery for pagination, and formatted event cards.
</objective>

<execution_context>
@/home/matkukla/.claude/get-shit-done/workflows/execute-plan.md
@/home/matkukla/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-grid-ui-core/04-RESEARCH.md

Dependencies from prior plans:
@frontend/src/components/ui/sheet.tsx
@frontend/src/types/journals.ts (from 04-01)
@frontend/src/hooks/useJournals.ts (from 04-02)
@frontend/src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EventTimelineDrawer component</name>
  <files>frontend/src/pages/journals/components/EventTimelineDrawer.tsx</files>
  <action>
Create the timeline drawer at `frontend/src/pages/journals/components/EventTimelineDrawer.tsx`:

```typescript
import * as React from "react"
import { formatDistanceToNow, format } from "date-fns"
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetDescription,
} from "@/components/ui/sheet"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { useStageEventsInfinite } from "@/hooks/useJournals"
import type { PipelineStage, StageEvent } from "@/types/journals"
import { STAGE_LABELS } from "@/types/journals"

export interface EventTimelineDrawerProps {
  /** Journal contact ID to fetch events for */
  journalContactId: string | null
  /** Pipeline stage to filter events */
  stage: PipelineStage | null
  /** Contact name for display */
  contactName: string
  /** Whether the drawer is open */
  isOpen: boolean
  /** Callback to close the drawer */
  onClose: () => void
}

/**
 * Event timeline drawer showing chronological events for a contact's stage.
 *
 * Uses useInfiniteQuery for "Load More" pagination.
 * Per RESEARCH.md: Load 5 events by default with load more option.
 */
export function EventTimelineDrawer({
  journalContactId,
  stage,
  contactName,
  isOpen,
  onClose,
}: EventTimelineDrawerProps) {
  const {
    data,
    fetchNextPage,
    hasNextPage,
    isFetchingNextPage,
    isLoading,
    isError,
    error,
  } = useStageEventsInfinite(journalContactId ?? "", stage ?? undefined, {
    enabled: isOpen && !!journalContactId,
    pageSize: 5,
  })

  // Flatten pages into single array
  const events = React.useMemo(() => {
    if (!data?.pages) return []
    return data.pages.flatMap((page) => page.results)
  }, [data])

  // Total count from first page
  const totalCount = data?.pages[0]?.count ?? 0

  return (
    <Sheet open={isOpen} onOpenChange={(open) => !open && onClose()}>
      <SheetContent side="right" className="w-full sm:w-[400px] overflow-y-auto">
        <SheetHeader className="pb-4 border-b">
          <SheetTitle>
            {stage ? STAGE_LABELS[stage] : "Events"} - {contactName}
          </SheetTitle>
          <SheetDescription>
            {totalCount > 0
              ? `${totalCount} event${totalCount !== 1 ? "s" : ""} recorded`
              : "No events recorded yet"}
          </SheetDescription>
        </SheetHeader>

        <div className="mt-6 space-y-1">
          {/* Loading state */}
          {isLoading && (
            <div className="flex items-center justify-center py-8 text-muted-foreground">
              Loading events...
            </div>
          )}

          {/* Error state */}
          {isError && (
            <div className="flex flex-col items-center justify-center py-8 text-destructive">
              <p>Failed to load events</p>
              <p className="text-sm text-muted-foreground">
                {error instanceof Error ? error.message : "Unknown error"}
              </p>
            </div>
          )}

          {/* Empty state */}
          {!isLoading && !isError && events.length === 0 && (
            <div className="flex items-center justify-center py-8 text-muted-foreground">
              No events recorded for this stage yet.
            </div>
          )}

          {/* Event timeline */}
          {events.map((event, index) => (
            <EventCard
              key={event.id}
              event={event}
              isFirst={index === 0}
              isLast={index === events.length - 1 && !hasNextPage}
            />
          ))}

          {/* Load more button */}
          {hasNextPage && (
            <div className="pt-4">
              <Button
                onClick={() => fetchNextPage()}
                disabled={isFetchingNextPage}
                variant="outline"
                className="w-full"
              >
                {isFetchingNextPage ? "Loading..." : "Load More"}
              </Button>
            </div>
          )}
        </div>
      </SheetContent>
    </Sheet>
  )
}

/**
 * Single event card in the timeline.
 */
interface EventCardProps {
  event: StageEvent
  isFirst: boolean
  isLast: boolean
}

function EventCard({ event, isFirst, isLast }: EventCardProps) {
  // Format event type for display (e.g., "call_logged" -> "Call Logged")
  const eventTypeLabel = event.event_type
    .split("_")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ")

  const relativeTime = formatDistanceToNow(new Date(event.created_at), {
    addSuffix: true,
  })

  const absoluteTime = format(new Date(event.created_at), "MMM d, yyyy 'at' h:mm a")

  return (
    <div className="relative pl-6 pb-6">
      {/* Timeline line */}
      {!isLast && (
        <div className="absolute left-[9px] top-4 bottom-0 w-[2px] bg-border" />
      )}

      {/* Timeline dot */}
      <div className="absolute left-0 top-1 w-[18px] h-[18px] rounded-full border-2 border-border bg-background flex items-center justify-center">
        <div className="w-2 h-2 rounded-full bg-primary" />
      </div>

      {/* Event content */}
      <div className="pt-0">
        <div className="flex items-start justify-between gap-2">
          <Badge variant="secondary" className="text-xs">
            {eventTypeLabel}
          </Badge>
          <span
            className="text-xs text-muted-foreground whitespace-nowrap"
            title={absoluteTime}
          >
            {relativeTime}
          </span>
        </div>

        {event.notes && (
          <p className="mt-2 text-sm text-foreground whitespace-pre-wrap">
            {event.notes}
          </p>
        )}

        {/* Metadata display (if present) */}
        {Object.keys(event.metadata).length > 0 && (
          <div className="mt-2 text-xs text-muted-foreground">
            {Object.entries(event.metadata).map(([key, value]) => (
              <span key={key} className="mr-2">
                {key}: {String(value)}
              </span>
            ))}
          </div>
        )}
      </div>
    </div>
  )
}
```

Key aspects per RESEARCH.md:
- Uses Sheet with side="right" and w-[400px] (desktop) / w-full (mobile)
- useStageEventsInfinite with enabled flag (only fetches when open)
- fetchNextPage called by Load More button
- hasNextPage determines button visibility
- formatDistanceToNow for relative times ("3 days ago")
- format for absolute time in title attribute (hover tooltip)
- Timeline visual with vertical line and dots
- overflow-y-auto on SheetContent for scrollable content
  </action>
  <verify>TypeScript compiles: `cd frontend && npx tsc --noEmit`</verify>
  <done>
EventTimelineDrawer component:
- Opens from right side with Sheet
- Uses useStageEventsInfinite for paginated data
- Shows loading state while fetching
- Has "Load More" button when hasNextPage is true
- Displays events in timeline format with dots and vertical line
- Shows relative time (formatDistanceToNow) and absolute time on hover
- Empty state when no events
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd frontend && npx tsc --noEmit`
2. Uses Sheet component: grep "Sheet" frontend/src/pages/journals/components/EventTimelineDrawer.tsx
3. Uses useStageEventsInfinite: grep "useStageEventsInfinite" frontend/src/pages/journals/components/EventTimelineDrawer.tsx
4. Has Load More button: grep "Load More" frontend/src/pages/journals/components/EventTimelineDrawer.tsx
5. Uses date-fns formatting: grep "formatDistanceToNow" frontend/src/pages/journals/components/EventTimelineDrawer.tsx
</verification>

<success_criteria>
- [ ] EventTimelineDrawer uses Sheet with side="right"
- [ ] Drawer width is w-full sm:w-[400px] for responsive design
- [ ] Uses useStageEventsInfinite hook with enabled flag
- [ ] Shows "Load More" button when hasNextPage is true
- [ ] Button disabled while isFetchingNextPage
- [ ] Events displayed with formatDistanceToNow relative time
- [ ] Timeline visual with vertical line connecting events
- [ ] Shows loading, error, and empty states appropriately
- [ ] All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-grid-ui-core/04-04-SUMMARY.md`
</output>
