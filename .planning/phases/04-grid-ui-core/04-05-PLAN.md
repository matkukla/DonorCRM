---
phase: 04-grid-ui-core
plan: 05
type: execute
wave: 3
depends_on: ["04-03", "04-04"]
files_modified:
  - frontend/src/pages/journals/JournalDetail.tsx
  - frontend/src/pages/journals/components/index.ts
  - frontend/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can navigate to journal detail page"
    - "Grid loads and displays journal members"
    - "Clicking stage cell opens timeline drawer"
    - "Drawer shows events for selected contact and stage"
  artifacts:
    - path: "frontend/src/pages/journals/JournalDetail.tsx"
      provides: "Journal detail page with grid and drawer"
      exports: ["JournalDetail"]
  key_links:
    - from: "frontend/src/pages/journals/JournalDetail.tsx"
      to: "frontend/src/pages/journals/components/JournalGrid.tsx"
      via: "JournalGrid import"
      pattern: "from.*./components"
    - from: "frontend/src/pages/journals/JournalDetail.tsx"
      to: "frontend/src/pages/journals/components/EventTimelineDrawer.tsx"
      via: "EventTimelineDrawer import"
      pattern: "EventTimelineDrawer"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/pages/journals/JournalDetail.tsx"
      via: "Route definition"
      pattern: "journals/:id"
---

<objective>
Integrate grid and drawer into journal detail page and add routing.

Purpose: This plan connects all Phase 4 components into a working page. Users navigate to a journal, see the grid, and click cells to open the timeline drawer.

Output: JournalDetail page component, route configuration, visual verification of complete feature.
</objective>

<execution_context>
@/home/matkukla/.claude/get-shit-done/workflows/execute-plan.md
@/home/matkukla/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-grid-ui-core/04-RESEARCH.md

Dependencies from prior plans:
@frontend/src/pages/journals/components/JournalGrid.tsx (from 04-03)
@frontend/src/pages/journals/components/EventTimelineDrawer.tsx (from 04-04)
@frontend/src/hooks/useJournals.ts (from 04-02)
@frontend/src/types/journals.ts (from 04-01)

Reference existing patterns:
@frontend/src/App.tsx
@frontend/src/pages/contacts/ContactDetail.tsx (if exists for pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create barrel export for journal components</name>
  <files>frontend/src/pages/journals/components/index.ts</files>
  <action>
Create barrel export file at `frontend/src/pages/journals/components/index.ts`:

```typescript
export { JournalGrid } from "./JournalGrid"
export { StageCell } from "./StageCell"
export { ContactNameCell } from "./ContactNameCell"
export { EventTimelineDrawer } from "./EventTimelineDrawer"
```

This simplifies imports in JournalDetail.tsx.
  </action>
  <verify>File exists and exports components: grep "export" frontend/src/pages/journals/components/index.ts</verify>
  <done>Barrel file exports all 4 journal components</done>
</task>

<task type="auto">
  <name>Task 2: Create JournalDetail page</name>
  <files>frontend/src/pages/journals/JournalDetail.tsx</files>
  <action>
Create the journal detail page at `frontend/src/pages/journals/JournalDetail.tsx`:

```typescript
import * as React from "react"
import { useParams, Link } from "react-router-dom"
import { ArrowLeft } from "lucide-react"
import { Button } from "@/components/ui/button"
import { useJournal, useJournalMembers } from "@/hooks/useJournals"
import { JournalGrid, EventTimelineDrawer } from "./components"
import type { PipelineStage, JournalMember } from "@/types/journals"

/**
 * State for the timeline drawer.
 */
interface DrawerState {
  isOpen: boolean
  journalContactId: string | null
  stage: PipelineStage | null
  contactName: string
}

const initialDrawerState: DrawerState = {
  isOpen: false,
  journalContactId: null,
  stage: null,
  contactName: "",
}

/**
 * Journal detail page showing the pipeline grid.
 *
 * Route: /journals/:id
 */
export default function JournalDetail() {
  const { id } = useParams<{ id: string }>()

  // Fetch journal details
  const { data: journal, isLoading: journalLoading, isError: journalError } = useJournal(id ?? "")

  // Fetch journal members for grid
  const {
    data: membersData,
    isLoading: membersLoading,
    isError: membersError,
  } = useJournalMembers(id ?? "")

  // Drawer state
  const [drawer, setDrawer] = React.useState<DrawerState>(initialDrawerState)

  // Handle stage cell click - open drawer
  const handleStageCellClick = React.useCallback(
    (contactId: string, stage: PipelineStage) => {
      // Find member to get contact name and journal_contact ID
      const member = membersData?.results.find((m) => m.contact === contactId)
      if (member) {
        setDrawer({
          isOpen: true,
          journalContactId: member.id, // This is the JournalContact ID
          stage,
          contactName: member.contact_name,
        })
      }
    },
    [membersData]
  )

  // Close drawer
  const handleCloseDrawer = React.useCallback(() => {
    setDrawer(initialDrawerState)
  }, [])

  // Loading state
  if (journalLoading || membersLoading) {
    return (
      <div className="container mx-auto py-8">
        <div className="flex items-center justify-center h-64 text-muted-foreground">
          Loading journal...
        </div>
      </div>
    )
  }

  // Error state
  if (journalError || !journal) {
    return (
      <div className="container mx-auto py-8">
        <div className="flex flex-col items-center justify-center h-64">
          <p className="text-destructive">Failed to load journal</p>
          <Link to="/journals" className="mt-4">
            <Button variant="outline">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Back to Journals
            </Button>
          </Link>
        </div>
      </div>
    )
  }

  const members = membersData?.results ?? []

  return (
    <div className="container mx-auto py-8 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Link to="/journals">
            <Button variant="ghost" size="icon">
              <ArrowLeft className="h-4 w-4" />
            </Button>
          </Link>
          <div>
            <h1 className="text-2xl font-bold">{journal.name}</h1>
            <p className="text-muted-foreground">
              Goal: ${parseFloat(journal.goal_amount).toLocaleString()}
              {journal.deadline && ` â€¢ Due ${new Date(journal.deadline).toLocaleDateString()}`}
            </p>
          </div>
        </div>
      </div>

      {/* Grid */}
      <div className="border rounded-lg bg-card">
        <JournalGrid
          members={members}
          onStageCellClick={handleStageCellClick}
          isLoading={membersLoading}
        />
      </div>

      {/* Members loading error */}
      {membersError && (
        <div className="text-center py-4 text-destructive">
          Failed to load journal members
        </div>
      )}

      {/* Timeline drawer */}
      <EventTimelineDrawer
        journalContactId={drawer.journalContactId}
        stage={drawer.stage}
        contactName={drawer.contactName}
        isOpen={drawer.isOpen}
        onClose={handleCloseDrawer}
      />
    </div>
  )
}
```

Key aspects:
- Uses useParams to get journal ID from route
- Manages drawer state with useState
- handleStageCellClick finds JournalContact ID from member data
- useCallback for memoized handlers
- Loading and error states
- Header shows journal name, goal, deadline
  </action>
  <verify>TypeScript compiles: `cd frontend && npx tsc --noEmit`</verify>
  <done>
JournalDetail page:
- Fetches journal and members
- Renders JournalGrid with members
- Opens EventTimelineDrawer on cell click
- Shows loading and error states
- Header displays journal name and goal
  </done>
</task>

<task type="auto">
  <name>Task 3: Add route to App.tsx</name>
  <files>frontend/src/App.tsx</files>
  <action>
Add journal detail route to frontend/src/App.tsx.

1. Add import at the top with other page imports:
```typescript
import JournalDetail from "@/pages/journals/JournalDetail"
```

2. Add route inside the protected routes section (look for pattern like `<Route path="/contacts/:id" ...`):
```typescript
<Route path="/journals/:id" element={<ProtectedPage><JournalDetail /></ProtectedPage>} />
```

Place this near other detail routes (contacts/:id, etc.) to maintain consistency.

Note: If journals routes don't exist yet, also add the list route:
```typescript
<Route path="/journals" element={<ProtectedPage><JournalList /></ProtectedPage>} />
```
And create a placeholder JournalList page if needed.
  </action>
  <verify>
1. Route exists: grep "journals/:id" frontend/src/App.tsx
2. Import exists: grep "JournalDetail" frontend/src/App.tsx
3. App compiles: cd frontend && npx tsc --noEmit
  </verify>
  <done>
App.tsx includes:
- Import for JournalDetail
- Route for /journals/:id with ProtectedPage wrapper
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 4 Grid UI Core feature:
- Tooltip component for hover states
- Badge orange variant for 1-3 month freshness
- TypeScript types for journal grid data
- Journal API client and React Query hooks
- JournalGrid with sticky headers and columns
- StageCell with color-coded freshness indicators
- EventTimelineDrawer with infinite scroll
- JournalDetail page integration
- Route configuration
  </what-built>
  <how-to-verify>
1. Start the frontend dev server: `cd frontend && npm run dev`

2. Navigate to a journal detail page:
   - URL: http://localhost:5173/journals/{journal-id}
   - Replace {journal-id} with a valid journal UUID from the database
   - Or access via the journals list if available

3. Verify grid layout:
   - [ ] Header row with stage names (Contact, Meet, Close, Decision, Thank, Next Steps)
   - [ ] First column shows contact names
   - [ ] Scroll horizontally - contact names stay fixed
   - [ ] Scroll vertically (if many contacts) - header row stays fixed

4. Verify stage cells:
   - [ ] Cells with events show checkmarks
   - [ ] Checkmark colors indicate freshness:
     - Green: events within last week
     - Yellow/Amber: events within last month
     - Orange: events within last 3 months
     - Red: events older than 3 months
   - [ ] Empty cells are clickable but have no checkmark

5. Verify tooltip:
   - [ ] Hover over a cell with events
   - [ ] Tooltip shows event type, relative time, notes preview
   - [ ] Tooltip appears after ~300ms delay

6. Verify timeline drawer:
   - [ ] Click any stage cell
   - [ ] Drawer slides in from right
   - [ ] Shows contact name and stage in header
   - [ ] Events displayed in chronological order
   - [ ] Each event shows type, relative time, notes
   - [ ] "Load More" button appears if more than 5 events
   - [ ] Clicking "Load More" fetches additional events
   - [ ] Click outside drawer or X to close
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd frontend && npx tsc --noEmit`
2. Route exists in App.tsx: grep "journals/:id" frontend/src/App.tsx
3. JournalDetail imports components: grep "JournalGrid\|EventTimelineDrawer" frontend/src/pages/journals/JournalDetail.tsx
4. Visual verification via checkpoint task
</verification>

<success_criteria>
- [ ] JournalDetail page renders journal name and goal
- [ ] JournalGrid displays contacts as rows and stages as columns
- [ ] Sticky header row stays fixed when scrolling vertically
- [ ] Sticky contact column stays fixed when scrolling horizontally
- [ ] Stage cells show color-coded checkmarks based on event freshness
- [ ] Hovering stage cell shows tooltip with event summary
- [ ] Clicking stage cell opens EventTimelineDrawer
- [ ] Drawer shows events with Load More pagination
- [ ] Route /journals/:id works and is protected
- [ ] All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-grid-ui-core/04-05-SUMMARY.md`
</output>
