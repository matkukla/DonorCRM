---
phase: 05-grid-interactions-decision-ui
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/journals/models.py
  - apps/journals/serializers.py
  - apps/journals/views.py
  - apps/journals/urls.py
  - apps/journals/tests/test_next_steps.py
autonomous: true

must_haves:
  truths:
    - "User can create a next step item via POST /api/v1/journals/next-steps/"
    - "User can mark a next step complete via PATCH with completed=true"
    - "User can list next steps filtered by journal_contact"
    - "Only owner can access their journal's next steps"
  artifacts:
    - path: "apps/journals/models.py"
      provides: "NextStep model"
      contains: "class NextStep"
    - path: "apps/journals/serializers.py"
      provides: "NextStepSerializer"
      contains: "class NextStepSerializer"
    - path: "apps/journals/views.py"
      provides: "NextStepViewSet"
      contains: "class NextStepViewSet"
    - path: "apps/journals/urls.py"
      provides: "next-steps route"
      contains: "next-steps"
  key_links:
    - from: "apps/journals/views.py"
      to: "apps/journals/models.py"
      via: "NextStep queryset"
      pattern: "NextStep\\.objects"
    - from: "apps/journals/views.py"
      to: "apps/journals/serializers.py"
      via: "serializer_class"
      pattern: "NextStepSerializer"
---

<objective>
Create backend model and API for Next Steps checklist items per journal contact.

Purpose: JRN-06 requires "User can create, edit, and mark complete checklist items per contact per journal." Per STATE.md decision, this links to journal context rather than reusing generic Task model.

Output: NextStep model, serializer, viewset, and tests - ready for frontend integration.
</objective>

<execution_context>
@/home/matkukla/.claude/get-shit-done/workflows/execute-plan.md
@/home/matkukla/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

# Existing journal models and patterns
@apps/journals/models.py
@apps/journals/serializers.py
@apps/journals/views.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NextStep model and migration</name>
  <files>apps/journals/models.py</files>
  <action>
Add NextStep model to apps/journals/models.py after DecisionHistory class:

```python
class NextStep(TimeStampedModel):
    """
    Checklist item for tracking next actions per journal contact.
    Independent items (not a single boolean) per JRN-06.
    """
    journal_contact = models.ForeignKey(
        'JournalContact',
        on_delete=models.CASCADE,
        related_name='next_steps',
        db_index=True
    )

    title = models.CharField(
        'title',
        max_length=255,
        help_text='Brief description of the next step'
    )

    notes = models.TextField(
        'notes',
        blank=True,
        help_text='Optional additional details'
    )

    due_date = models.DateField(
        'due date',
        null=True,
        blank=True,
        help_text='Optional target completion date'
    )

    completed = models.BooleanField(
        'completed',
        default=False,
        db_index=True
    )

    completed_at = models.DateTimeField(
        'completed at',
        null=True,
        blank=True
    )

    order = models.PositiveIntegerField(
        'display order',
        default=0,
        help_text='Order in checklist (lower = first)'
    )

    class Meta:
        db_table = 'journal_next_steps'
        verbose_name = 'next step'
        verbose_name_plural = 'next steps'
        ordering = ['order', 'created_at']
        indexes = [
            models.Index(fields=['journal_contact', 'completed']),
        ]

    def __str__(self):
        status = "Done" if self.completed else "Pending"
        return f'{self.title} ({status})'

    def mark_complete(self):
        """Mark this step as completed."""
        from django.utils import timezone
        self.completed = True
        self.completed_at = timezone.now()
        self.save(update_fields=['completed', 'completed_at', 'updated_at'])
```

After adding the model, generate and apply migration:
```bash
cd /home/matkukla/projects/DonorCRM && python manage.py makemigrations journals --name add_next_step_model
python manage.py migrate
```
  </action>
  <verify>
```bash
cd /home/matkukla/projects/DonorCRM && python manage.py showmigrations journals | grep -E "^\s+\[X\].*add_next_step"
```
Migration applied (shows [X]).
  </verify>
  <done>NextStep model exists with fields: journal_contact, title, notes, due_date, completed, completed_at, order. Migration applied.</done>
</task>

<task type="auto">
  <name>Task 2: Add serializer, viewset, and URL routing</name>
  <files>
apps/journals/serializers.py
apps/journals/views.py
apps/journals/urls.py
  </files>
  <action>
**1. Add NextStepSerializer to serializers.py:**

```python
class NextStepSerializer(serializers.ModelSerializer):
    """Serializer for NextStep model with ownership validation."""

    class Meta:
        model = NextStep
        fields = [
            'id', 'journal_contact', 'title', 'notes',
            'due_date', 'completed', 'completed_at', 'order',
            'created_at', 'updated_at'
        ]
        read_only_fields = ['id', 'completed_at', 'created_at', 'updated_at']

    def validate_journal_contact(self, value):
        """Ensure user owns the journal that contains this contact."""
        request = self.context.get('request')
        if request and not request.user.is_staff:
            if value.journal.owner != request.user:
                raise serializers.ValidationError(
                    "You don't have permission to add next steps to this journal contact."
                )
        return value

    def update(self, instance, validated_data):
        """Handle completed timestamp when marking complete."""
        if validated_data.get('completed') and not instance.completed:
            from django.utils import timezone
            validated_data['completed_at'] = timezone.now()
        elif 'completed' in validated_data and not validated_data['completed']:
            validated_data['completed_at'] = None
        return super().update(instance, validated_data)
```

Import NextStep at top of serializers.py:
```python
from .models import ..., NextStep
```

**2. Add NextStepViewSet to views.py:**

```python
class NextStepViewSet(viewsets.ModelViewSet):
    """
    API endpoint for managing next steps checklist items.

    Supports: list, create, retrieve, update, partial_update, destroy
    Filter by: journal_contact, completed
    """
    serializer_class = NextStepSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        """Filter to next steps in journals owned by user (or all for staff)."""
        user = self.request.user
        if user.is_staff:
            qs = NextStep.objects.all()
        else:
            qs = NextStep.objects.filter(journal_contact__journal__owner=user)

        # Filter by journal_contact
        journal_contact_id = self.request.query_params.get('journal_contact')
        if journal_contact_id:
            qs = qs.filter(journal_contact_id=journal_contact_id)

        # Filter by completed status
        completed = self.request.query_params.get('completed')
        if completed is not None:
            qs = qs.filter(completed=completed.lower() == 'true')

        return qs.select_related('journal_contact__journal', 'journal_contact__contact')
```

Import NextStep and NextStepSerializer at top of views.py.

**3. Add URL route in urls.py:**

Add to the router registrations:
```python
router.register(r'next-steps', NextStepViewSet, basename='nextstep')
```
  </action>
  <verify>
```bash
cd /home/matkukla/projects/DonorCRM && python manage.py check
```
No errors.
  </verify>
  <done>
- NextStepSerializer with ownership validation
- NextStepViewSet with queryset filtering
- URL route at /api/v1/journals/next-steps/
  </done>
</task>

<task type="auto">
  <name>Task 3: Add integration tests for NextStep API</name>
  <files>apps/journals/tests/test_next_steps.py</files>
  <action>
Create apps/journals/tests/test_next_steps.py with comprehensive tests:

```python
"""
Tests for NextStep API endpoints.
"""
from decimal import Decimal
from django.contrib.auth import get_user_model
from rest_framework import status
from rest_framework.test import APITestCase

from apps.contacts.models import Contact
from apps.journals.models import Journal, JournalContact, NextStep


User = get_user_model()


class NextStepAPITests(APITestCase):
    """Test NextStep CRUD operations and permissions."""

    def setUp(self):
        """Create test users, journals, and contacts."""
        self.user = User.objects.create_user(
            email='test@example.com',
            password='testpass123'
        )
        self.other_user = User.objects.create_user(
            email='other@example.com',
            password='testpass123'
        )

        # Create contact owned by user
        self.contact = Contact.objects.create(
            owner=self.user,
            first_name='Test',
            last_name='Contact',
            email='contact@example.com'
        )

        # Create journal and membership
        self.journal = Journal.objects.create(
            owner=self.user,
            name='Test Journal',
            goal_amount=Decimal('10000.00')
        )
        self.journal_contact = JournalContact.objects.create(
            journal=self.journal,
            contact=self.contact
        )

        self.client.force_authenticate(user=self.user)

    def test_create_next_step(self):
        """User can create a next step for their journal contact."""
        data = {
            'journal_contact': str(self.journal_contact.id),
            'title': 'Send thank you note',
            'notes': 'Include personal message',
            'due_date': '2025-02-01'
        }
        response = self.client.post('/api/v1/journals/next-steps/', data)
        self.assertEqual(response.status_code, status.HTTP_201_CREATED)
        self.assertEqual(response.data['title'], 'Send thank you note')
        self.assertFalse(response.data['completed'])

    def test_list_next_steps_filtered(self):
        """User can list next steps filtered by journal_contact."""
        NextStep.objects.create(
            journal_contact=self.journal_contact,
            title='Step 1'
        )
        NextStep.objects.create(
            journal_contact=self.journal_contact,
            title='Step 2'
        )

        response = self.client.get(
            f'/api/v1/journals/next-steps/?journal_contact={self.journal_contact.id}'
        )
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(response.data['count'], 2)

    def test_mark_complete(self):
        """User can mark a next step as complete."""
        step = NextStep.objects.create(
            journal_contact=self.journal_contact,
            title='Call donor'
        )

        response = self.client.patch(
            f'/api/v1/journals/next-steps/{step.id}/',
            {'completed': True}
        )
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertTrue(response.data['completed'])
        self.assertIsNotNone(response.data['completed_at'])

    def test_unmark_complete(self):
        """User can unmark a completed next step."""
        from django.utils import timezone
        step = NextStep.objects.create(
            journal_contact=self.journal_contact,
            title='Call donor',
            completed=True,
            completed_at=timezone.now()
        )

        response = self.client.patch(
            f'/api/v1/journals/next-steps/{step.id}/',
            {'completed': False}
        )
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertFalse(response.data['completed'])
        self.assertIsNone(response.data['completed_at'])

    def test_delete_next_step(self):
        """User can delete their next step."""
        step = NextStep.objects.create(
            journal_contact=self.journal_contact,
            title='To delete'
        )

        response = self.client.delete(f'/api/v1/journals/next-steps/{step.id}/')
        self.assertEqual(response.status_code, status.HTTP_204_NO_CONTENT)
        self.assertFalse(NextStep.objects.filter(id=step.id).exists())

    def test_other_user_cannot_access(self):
        """Other users cannot see or modify another user's next steps."""
        step = NextStep.objects.create(
            journal_contact=self.journal_contact,
            title='Private step'
        )

        self.client.force_authenticate(user=self.other_user)

        # Cannot list
        response = self.client.get('/api/v1/journals/next-steps/')
        self.assertEqual(response.data['count'], 0)

        # Cannot retrieve
        response = self.client.get(f'/api/v1/journals/next-steps/{step.id}/')
        self.assertEqual(response.status_code, status.HTTP_404_NOT_FOUND)

    def test_cannot_create_for_others_journal(self):
        """User cannot create next step in another user's journal."""
        other_journal = Journal.objects.create(
            owner=self.other_user,
            name='Other Journal',
            goal_amount=Decimal('5000.00')
        )
        other_contact = Contact.objects.create(
            owner=self.other_user,
            first_name='Other',
            last_name='Contact'
        )
        other_jc = JournalContact.objects.create(
            journal=other_journal,
            contact=other_contact
        )

        data = {
            'journal_contact': str(other_jc.id),
            'title': 'Sneaky step'
        }
        response = self.client.post('/api/v1/journals/next-steps/', data)
        self.assertEqual(response.status_code, status.HTTP_400_BAD_REQUEST)

    def test_filter_by_completed(self):
        """User can filter next steps by completed status."""
        NextStep.objects.create(
            journal_contact=self.journal_contact,
            title='Pending',
            completed=False
        )
        NextStep.objects.create(
            journal_contact=self.journal_contact,
            title='Done',
            completed=True
        )

        # Filter pending
        response = self.client.get('/api/v1/journals/next-steps/?completed=false')
        self.assertEqual(response.data['count'], 1)
        self.assertEqual(response.data['results'][0]['title'], 'Pending')

        # Filter completed
        response = self.client.get('/api/v1/journals/next-steps/?completed=true')
        self.assertEqual(response.data['count'], 1)
        self.assertEqual(response.data['results'][0]['title'], 'Done')
```
  </action>
  <verify>
```bash
cd /home/matkukla/projects/DonorCRM && python manage.py test apps.journals.tests.test_next_steps -v 2
```
All tests pass.
  </verify>
  <done>8 tests covering: create, list with filter, mark complete, unmark complete, delete, ownership enforcement, cross-user protection, completed filter</done>
</task>

</tasks>

<verification>
1. Model exists: `grep "class NextStep" apps/journals/models.py`
2. Migration applied: `python manage.py showmigrations journals`
3. Serializer exists: `grep "class NextStepSerializer" apps/journals/serializers.py`
4. ViewSet exists: `grep "class NextStepViewSet" apps/journals/views.py`
5. URL route: `grep "next-steps" apps/journals/urls.py`
6. All tests pass: `python manage.py test apps.journals.tests.test_next_steps`
</verification>

<success_criteria>
- NextStep model with all fields (title, notes, due_date, completed, completed_at, order)
- Migration generated and applied
- NextStepSerializer with ownership validation
- NextStepViewSet with filtering by journal_contact and completed
- URL route /api/v1/journals/next-steps/
- 8+ tests passing for CRUD and permissions
</success_criteria>

<output>
After completion, create `.planning/phases/05-grid-interactions-decision-ui/05-02-SUMMARY.md`
</output>
