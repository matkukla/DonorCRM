---
phase: 05-grid-interactions-decision-ui
plan: 06
type: execute
wave: 4
depends_on: ["05-03", "05-04", "05-05"]
files_modified:
  - frontend/src/pages/journals/JournalDetail.tsx
  - frontend/src/pages/journals/components/JournalGrid.tsx
autonomous: false

must_haves:
  truths:
    - "Journal detail page shows header with progress bar and stats"
    - "Grid shows decision column with clickable cells"
    - "Grid shows next steps column with checklist popover"
    - "Stage cells show warnings for non-sequential movement"
    - "Header totals update when decisions change"
  artifacts:
    - path: "frontend/src/pages/journals/JournalDetail.tsx"
      provides: "Integrated journal page with header and grid"
      contains: "JournalHeader"
    - path: "frontend/src/pages/journals/components/JournalGrid.tsx"
      provides: "Grid with decision and next steps columns"
      contains: "DecisionCell"
  key_links:
    - from: "frontend/src/pages/journals/JournalDetail.tsx"
      to: "frontend/src/pages/journals/components/JournalHeader.tsx"
      via: "component import"
      pattern: "import.*JournalHeader"
    - from: "frontend/src/pages/journals/components/JournalGrid.tsx"
      to: "frontend/src/pages/journals/components/DecisionCell.tsx"
      via: "component import"
      pattern: "import.*DecisionCell"
---

<objective>
Integrate all Phase 5 components into JournalDetail page and JournalGrid.

Purpose: This final plan connects JournalHeader, DecisionCell, NextStepsCell, and enhanced StageCell into the working journal UI. Requires human verification of the complete interactive experience.

Output: Fully integrated journal page with all Phase 5 features working together.
</objective>

<execution_context>
@/home/matkukla/.claude/get-shit-done/workflows/execute-plan.md
@/home/matkukla/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-grid-interactions-decision-ui/05-RESEARCH.md

# Components to integrate
@frontend/src/pages/journals/JournalDetail.tsx
@frontend/src/pages/journals/components/JournalGrid.tsx
@frontend/src/pages/journals/components/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update JournalGrid with decision and next steps columns</name>
  <files>frontend/src/pages/journals/components/JournalGrid.tsx</files>
  <action>
Update JournalGrid to include Decision and Next Steps columns.

1. Add imports:
```typescript
import { DecisionCell } from "./DecisionCell"
import { NextStepsCell } from "./NextStepsCell"
import { getHighestStageWithEvents } from "./StageCell"
```

2. Update JournalGridProps to include journalId:
```typescript
export interface JournalGridProps {
  /** Journal members to display as rows */
  members: JournalMember[]
  /** Journal ID for decision hooks */
  journalId: string
  /** Callback when a stage cell is clicked (opens timeline drawer) */
  onStageCellClick: (contactId: string, stage: PipelineStage) => void
  /** Loading state */
  isLoading?: boolean
}
```

3. Update table header to add Decision column after stage columns and before any action column:
```typescript
<TableHeader>
  <TableRow className="bg-background">
    {/* Contact column */}
    <TableHead className="sticky top-0 left-0 z-30 bg-background min-w-[200px] w-[200px] border-r">
      Contact
    </TableHead>
    {/* Stage columns */}
    {PIPELINE_STAGES.map((stage) => (
      <TableHead
        key={stage}
        className="sticky top-0 z-10 bg-background text-center min-w-[100px] w-[100px]"
      >
        {STAGE_LABELS[stage]}
      </TableHead>
    ))}
    {/* Decision column */}
    <TableHead className="sticky top-0 z-10 bg-background text-center min-w-[140px] w-[140px]">
      Decision
    </TableHead>
    {/* Next Steps column */}
    <TableHead className="sticky top-0 z-10 bg-background text-center min-w-[100px] w-[100px]">
      Next Steps
    </TableHead>
  </TableRow>
</TableHeader>
```

4. Update table body to include decision and next steps cells:
```typescript
<TableBody>
  {members.map((member) => {
    const currentStage = getHighestStageWithEvents(member.stage_events)
    return (
      <TableRow key={member.id}>
        {/* Contact name cell */}
        <TableCell className="sticky left-0 z-20 bg-background border-r min-w-[200px] w-[200px]">
          <ContactNameCell
            name={member.contact_name}
            email={member.contact_email}
            status={member.contact_status}
          />
        </TableCell>
        {/* Stage cells */}
        {PIPELINE_STAGES.map((stage) => {
          const eventSummary = getStageEventSummary(member, stage)
          return (
            <TableCell key={stage} className="text-center p-2 min-w-[100px] w-[100px]">
              <StageCell
                contactId={member.contact}
                stage={stage}
                eventSummary={eventSummary}
                currentStage={currentStage}
                onCellClick={handleCellClick}
              />
            </TableCell>
          )
        })}
        {/* Decision cell */}
        <TableCell className="p-2 min-w-[140px] w-[140px]">
          <DecisionCell
            decision={member.decision}
            journalContactId={member.id}
            journalId={journalId}
            contactName={member.contact_name}
          />
        </TableCell>
        {/* Next Steps cell */}
        <TableCell className="text-center p-2 min-w-[100px] w-[100px]">
          <NextStepsCell journalContactId={member.id} />
        </TableCell>
      </TableRow>
    )
  })}
</TableBody>
```

5. Update table min-width to accommodate new columns:
```typescript
<Table className="min-w-[1200px]">
```

6. Update the component signature to accept journalId:
```typescript
export function JournalGrid({
  members,
  journalId,
  onStageCellClick,
  isLoading = false,
}: JournalGridProps) {
```
  </action>
  <verify>
```bash
cd /home/matkukla/projects/DonorCRM/frontend && npx tsc --noEmit
```
No TypeScript errors.
  </verify>
  <done>
- JournalGrid includes Decision column with DecisionCell
- JournalGrid includes Next Steps column with NextStepsCell
- StageCell receives currentStage prop for transition warnings
- Table min-width increased to accommodate new columns
  </done>
</task>

<task type="auto">
  <name>Task 2: Update JournalDetail with header integration</name>
  <files>frontend/src/pages/journals/JournalDetail.tsx</files>
  <action>
Update JournalDetail page to include JournalHeader and pass journalId to grid.

1. Add import:
```typescript
import { JournalGrid, EventTimelineDrawer, JournalHeader } from "./components"
```

2. Replace the existing header section with JournalHeader component:

Change this section:
```typescript
{/* Header */}
<div className="flex items-center justify-between">
  <div className="flex items-center gap-4">
    <Link to="/journals">
      <Button variant="ghost" size="icon">
        <ArrowLeft className="h-4 w-4" />
      </Button>
    </Link>
    <div>
      <h1 className="text-2xl font-bold">{journal.name}</h1>
      <p className="text-muted-foreground">
        Goal: ${parseFloat(journal.goal_amount).toLocaleString()}
        {journal.deadline && ` â€¢ Due ${new Date(journal.deadline).toLocaleDateString()}`}
      </p>
    </div>
  </div>
</div>
```

To:
```typescript
{/* Back button */}
<div className="flex items-center gap-4">
  <Link to="/journals">
    <Button variant="ghost" size="icon">
      <ArrowLeft className="h-4 w-4" />
    </Button>
  </Link>
</div>

{/* Header with stats */}
<JournalHeader journal={journal} members={members} />
```

3. Pass journalId to JournalGrid:
```typescript
<JournalGrid
  members={members}
  journalId={id ?? ""}
  onStageCellClick={handleStageCellClick}
  isLoading={membersLoading}
/>
```

4. Make sure the component structure flows well:
- Back button on its own line
- JournalHeader with stats and progress bar
- Then the grid
  </action>
  <verify>
```bash
cd /home/matkukla/projects/DonorCRM/frontend && npx tsc --noEmit
```
No TypeScript errors.
  </verify>
  <done>
- JournalDetail imports JournalHeader
- JournalHeader rendered with journal and members props
- JournalGrid receives journalId prop
- Layout flows: back button, header with stats, grid
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 5 integration: Journal page with interactive grid, decision editing, next steps, stage warnings, and progress tracking.
  </what-built>
  <how-to-verify>
1. Start the development servers:
   ```bash
   cd /home/matkukla/projects/DonorCRM && python manage.py runserver &
   cd /home/matkukla/projects/DonorCRM/frontend && npm run dev
   ```

2. Navigate to a journal detail page (e.g., http://localhost:5173/journals/{id})

3. Verify JournalHeader (JRN-14):
   - [ ] Shows journal name at top
   - [ ] Shows goal amount
   - [ ] Shows deadline (if set)
   - [ ] Shows progress bar with percentage
   - [ ] Shows total decisions count
   - [ ] Shows total pledged amount

4. Verify Decision Column (JRN-13):
   - [ ] Decision column visible in grid
   - [ ] Cells with decisions show amount, cadence, status badge
   - [ ] Status badge is color-coded (green=active, yellow=pending, red=declined)
   - [ ] Empty cells show "Add" button
   - [ ] Clicking opens DecisionDialog
   - [ ] Dialog has amount, cadence (dropdown), status (dropdown) fields
   - [ ] Saving updates UI immediately (optimistic)
   - [ ] Header totals update after saving decision

5. Verify Stage Movement Warnings (JRN-05):
   - [ ] Click a stage cell for a contact that has events in earlier stage
   - [ ] If skipping stages forward, warning toast appears
   - [ ] If going backward, "Revisiting stage" toast appears
   - [ ] Stage event creation still proceeds (no hard block)

6. Verify Next Steps Checklist (JRN-06):
   - [ ] Next Steps column visible in grid
   - [ ] Shows count (e.g., "0" or "2/3")
   - [ ] Clicking opens popover with checklist
   - [ ] Can check/uncheck items
   - [ ] Can add new step via input + Enter
   - [ ] Can delete steps (trash icon on hover)
   - [ ] Changes persist after closing/reopening popover

7. Verify Efficiency (Success Criteria #7):
   - [ ] Grid doesn't fully re-render when editing one cell
   - [ ] No visible lag when toggling next steps
   - [ ] Progress bar updates without full page flash
  </how-to-verify>
  <resume-signal>
Type "approved" if all checks pass.
If issues found, describe them and I'll fix.
  </resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd frontend && npx tsc --noEmit`
2. JournalHeader import: `grep "JournalHeader" frontend/src/pages/journals/JournalDetail.tsx`
3. JournalId passed: `grep "journalId=" frontend/src/pages/journals/JournalDetail.tsx`
4. DecisionCell in grid: `grep "DecisionCell" frontend/src/pages/journals/components/JournalGrid.tsx`
5. NextStepsCell in grid: `grep "NextStepsCell" frontend/src/pages/journals/components/JournalGrid.tsx`
6. Human verification of all interactive features
</verification>

<success_criteria>
- JournalDetail page shows JournalHeader with progress bar and stats
- JournalGrid includes Decision column with DecisionCell
- JournalGrid includes Next Steps column with NextStepsCell
- StageCell shows warnings for non-sequential transitions
- All TypeScript compiles
- Human verification confirms all 7 success criteria from roadmap
</success_criteria>

<output>
After completion, create `.planning/phases/05-grid-interactions-decision-ui/05-06-SUMMARY.md`
</output>
